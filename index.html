<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web Ragdoll Studio - SMG4 Style</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Segoe UI', sans-serif; }
        #ui { 
            position: absolute; top: 15px; left: 15px; z-index: 10; 
            background: rgba(20, 20, 20, 0.9); color: #00d2ff; padding: 20px; 
            border-radius: 10px; border: 2px solid #00d2ff; width: 260px;
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.3);
        }
        h2 { font-size: 1.2em; margin: 0 0 10px 0; text-align: center; text-shadow: 0 0 5px #00d2ff; }
        label { font-size: 0.8em; color: #fff; display: block; margin-bottom: 5px; }
        input, button { 
            width: 100%; padding: 10px; margin-bottom: 12px; border-radius: 5px; 
            border: 1px solid #00d2ff; background: #111; color: white; cursor: pointer;
        }
        button { background: #00d2ff; color: #000; font-weight: bold; }
        button:hover { background: #0095b5; }
        .controls-info { font-size: 0.75em; color: #aaa; line-height: 1.4; border-top: 1px solid #333; pt: 10px; }
        canvas { display: block; touch-action: none; }
    </style>
</head>
<body>

    <div id="ui">
        <h2>MINI GMOD WEB</h2>
        <label>COULEUR FOND (CHROMA)</label>
        <input type="color" id="bgColor" value="#00ff00">
        
        <label>MODÈLE PERSO (.GLB)</label>
        <input type="file" id="fileInput" accept=".glb">
        
        <button id="resetBtn">RÉINITIALISER TOUT</button>
        
        <div class="controls-info">
            • <b>Grip</b> : Clic Gauche / 1 Doigt<br>
            • <b>Freeze/Unfreeze</b> : Clic Droit / Appui Long<br>
            • <b>Vue</b> : Rotation (vide) / Zoom (molette)
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "cannon-es": "https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/+esm"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import * as CANNON from 'cannon-es';

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x00ff00);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        scene.add(new THREE.AmbientLight(0xffffff, 1), new THREE.DirectionalLight(0xffffff, 1));

        const world = new CANNON.World({ gravity: new CANNON.Vec3(0, -9.81, 0) });
        const ground = new CANNON.Body({ mass: 0, shape: new CANNON.Plane() });
        ground.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
        world.addBody(ground);

        let ragdollParts = [];
        const dummyBody = new CANNON.Body({ mass: 0 });
        world.addBody(dummyBody);
        let mouseConstraint = null;

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let hoveredMesh = null;

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || !file.name.toLowerCase().endsWith('.glb')) return;
            new GLTFLoader().load(URL.createObjectURL(file), (gltf) => {
                const model = gltf.scene;
                scene.add(model);
                model.traverse(n => { if(n.isBone) n.rotation.set(0,0,0); }); // T-POSE

                const box = new THREE.Box3().setFromObject(model);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());
                camera.position.set(center.x, center.y, center.z + size.y * 2.5);
                controls.target.copy(center);

                model.traverse(node => {
                    if (node.isBone) {
                        const body = new CANNON.Body({ mass: 1, shape: new CANNON.Sphere(0.12) });
                        const v = new THREE.Vector3();
                        node.getWorldPosition(v);
                        body.position.copy(v);
                        world.addBody(body);
                        ragdollParts.push({ bone: node, body: body, initPos: v.clone(), frozen: false });

                        if (node.parent && node.parent.isBone) {
                            const parent = ragdollParts.find(p => p.bone === node.parent);
                            if (parent) world.addConstraint(new CANNON.PointToPointConstraint(body, new CANNON.Vec3(0,0,0), parent.body, new CANNON.Vec3(0,0,0)));
                        }
                    }
                    if(node.isMesh) node.material = node.material.clone();
                });
            });
        });

        function getTargetPart() {
            let closest = null; let minDist = 0.35;
            ragdollParts.forEach(p => {
                const screenPos = p.bone.getWorldPosition(new THREE.Vector3()).project(camera);
                const d = mouse.distanceTo(new THREE.Vector2(screenPos.x, screenPos.y));
                if (d < minDist) { minDist = d; closest = p; }
            });
            return closest;
        }

        window.onpointerdown = (e) => {
            const part = getTargetPart();
            if (part) {
                if (e.button === 2) { // CLIC DROIT = FREEZE
                    part.frozen = !part.frozen;
                    part.body.mass = part.frozen ? 0 : 1;
                    part.body.updateMassProperties();
                    part.body.velocity.set(0,0,0);
                } else { // CLIC GAUCHE = DRAG
                    controls.enabled = false;
                    mouseConstraint = new CANNON.PointToPointConstraint(part.body, new CANNON.Vec3(0,0,0), dummyBody, new CANNON.Vec3(0,0,0), 2000);
                    world.addConstraint(mouseConstraint);
                }
            }
        };

        window.onpointermove = (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            
            // Highlight Blender/GMod
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);
            if (hoveredMesh) hoveredMesh.material.color.set(0xffffff);
            if (intersects.length > 0) {
                hoveredMesh = intersects[0].object;
                hoveredMesh.material.color.set(0x666666);
            }

            const vector = new THREE.Vector3(mouse.x, mouse.y, 0.5).unproject(camera);
            const dir = vector.sub(camera.position).normalize();
            dummyBody.position.copy(camera.position.clone().add(dir.multiplyScalar(camera.position.distanceTo(controls.target))));
        };

        window.onpointerup = () => {
            controls.enabled = true;
            if (mouseConstraint) { world.removeConstraint(mouseConstraint); mouseConstraint = null; }
        };

        window.oncontextmenu = (e) => e.preventDefault(); // Bloquer menu clic droit

        document.getElementById('resetBtn').onclick = () => location.reload();
        document.getElementById('bgColor').oninput = (e) => scene.background.set(e.target.value);

        function animate() {
            requestAnimationFrame(animate);
            world.fixedStep();
            controls.update();
            ragdollParts.forEach(p => {
                p.bone.position.copy(p.body.position);
                p.bone.quaternion.copy(p.body.quaternion);
                if(p.bone.parent) p.bone.parent.worldToLocal(p.bone.position);
            });
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
